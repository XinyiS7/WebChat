<!DOCTYPE html><html><head>    <title>DeepSeek Chat</title>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <!-- 引入Markdown渲染库 -->    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github.min.css">    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>    <script src="https://cdn.jsdelivr.net/npm/highlight.js/lib/core.min.js"></script>    <style>        /* 完整聊天界面样式 */        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }        #chat-container { border: 1px solid #ddd; border-radius: 8px; height: 500px; overflow-y: auto; padding: 15px; margin-bottom: 15px; }        .message { margin-bottom: 15px; }        .user-message { color: #333; }        .bot-message { color: #444; background: #f9f9f9; padding: 10px; border-radius: 5px; }        textarea { width: 100%; padding: 10px; margin-bottom: 10px; }        button { padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }        .mode-switch { display: flex; align-items: center; margin-bottom: 10px; }        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }        code { color: #d63384; }    </style></head><body>    <h1>DeepSeek Chat</h1>    <div class="mode-switch">        <label class="switch">            <input type="checkbox" id="modeSwitch">            <span class="slider"></span>        </label>        <span class="mode-label">当前模式: <span id="modeText">chat</span></span>    </div>    <div id="chat-container">        <!-- 聊天消息将在这里动态渲染 -->    </div>    <form id="chat-form">        {% csrf_token %}        <input type="hidden" id="selectedMode" name="mode" value="chat">        <textarea name="input_text" rows="5" placeholder="输入你的消息..."></textarea><br>        <button type="submit">发送</button>    </form>    <script>        // 初始化Markdown渲染        marked.setOptions({            highlight: function(code, lang) {                if (lang && hljs.getLanguage(lang)) {                    return hljs.highlight(lang, code).value;                }                return hljs.highlightAuto(code).value;            }        });        // 模式切换逻辑        document.getElementById('modeSwitch').addEventListener('change', function() {            const modeText = document.getElementById('modeText');            const selectedMode = document.getElementById('selectedMode');            if (this.checked) {                modeText.textContent = 'coder';                selectedMode.value = 'coder';            } else {                modeText.textContent = 'chat';                selectedMode.value = 'chat';            }        });        // 从sessionStorage加载历史消息        function loadChatHistory() {            const history = JSON.parse(sessionStorage.getItem('chatHistory') || '[]');            const chatContainer = document.getElementById('chat-container');            chatContainer.innerHTML = '';            history.forEach(msg => {                appendMessage(msg.role, msg.content);            });        }        // 添加新消息到聊天界面        function appendMessage(role, content) {            const chatContainer = document.getElementById('chat-container');            const messageDiv = document.createElement('div');            messageDiv.className = `message ${role}-message`;            // 如果是AI回复且是Markdown格式            if (role === 'bot') {                messageDiv.innerHTML = marked.parse(content);            } else {                messageDiv.textContent = content;            }            chatContainer.appendChild(messageDiv);            chatContainer.scrollTop = chatContainer.scrollHeight;        }        // 提交表单处理        document.getElementById('chat-form').addEventListener('submit', async function(e) {            e.preventDefault();            const formData = new FormData(this);            const inputText = formData.get('input_text');            const mode = formData.get('mode');            if (!inputText.trim()) return;            // 添加用户消息到界面            appendMessage('user', inputText);            // 保存到历史记录            let history = JSON.parse(sessionStorage.getItem('chatHistory') || '[]');            history.push({ role: 'user', content: inputText });            sessionStorage.setItem('chatHistory', JSON.stringify(history));            // 清空输入框            this.querySelector('textarea').value = '';            try {                // 显示"正在思考"提示                const thinkingDiv = document.createElement('div');                thinkingDiv.className = 'message bot-message';                thinkingDiv.textContent = '思考中...';                document.getElementById('chat-container').appendChild(thinkingDiv);                // 发送AJAX请求                const response = await fetch('{% url "process_text_mdview_swt" %}', {                    method: 'POST',                    headers: {                        'X-Requested-With': 'XMLHttpRequest',                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')                    },                    body: formData                });                // 移除"思考中"提示                document.querySelector('#chat-container .bot-message:last-child').remove();                if (response.ok) {                    const data = await response.json();                    // 添加AI回复到界面                    appendMessage('bot', data.processed_text);                    // 更新历史记录                    history.push({ role: 'bot', content: data.processed_text });                    sessionStorage.setItem('chatHistory', JSON.stringify(history));                } else {                    throw new Error('请求失败');                }            } catch (error) {                console.error('Error:', error);                appendMessage('bot', '抱歉，发生错误: ' + error.message);            }        });        // 页面加载时初始化聊天记录        document.addEventListener('DOMContentLoaded', loadChatHistory);    </script></body></html>